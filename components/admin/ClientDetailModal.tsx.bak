'use client';

import { useState, useEffect } from 'react';
import type { Client } from '@/lib/db/schema';
import ConfirmationDialog from '@/components/ui/ConfirmationDialog';
import DatePicker from '@/components/products/DatePicker';
import t from '@/lib/admin-translations-extended';
import { PDFDownloadLink } from '@react-pdf/renderer';
import InvoicePDF from './pdf/InvoicePDF';
import { Briefcase, X, FileDown, Download } from 'lucide-react';

interface OrderItem {
  id: string;
  product_name: string;
  quantity: number;
  unit_price: string;
  subtotal: string;
}

interface Order {
  id: string;
  order_number: string | null;
  total_amount: string;
  delivery_date: string | null;
  created_at: string;
  paid: boolean;
  channel: string;
  order_items?: OrderItem[];
}

interface ClientDetailModalProps {
  client: Client;
  onClose: () => void;
  onUpdate: (updatedClient: Client) => void;
  onDelete: () => void;
}

export default function ClientDetailModal({ client, onClose, onUpdate, onDelete }: ClientDetailModalProps) {
  // Lock body scroll when modal is open
  useEffect(() => {
    const originalOverflow = document.body.style.overflow;
    document.body.style.overflow = 'hidden';
    return () => {
      document.body.style.overflow = originalOverflow;
    };
  }, []);

  const [isEditing, setIsEditing] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [orders, setOrders] = useState<Order[]>([]);
  const [isLoadingOrders, setIsLoadingOrders] = useState(true);
  
  // Invoice generation state
  const [showInvoiceGenerator, setShowInvoiceGenerator] = useState(false);
  const [invoiceFromDate, setInvoiceFromDate] = useState<Date | undefined>();
  const [invoiceToDate, setInvoiceToDate] = useState<Date | undefined>();
  const [formData, setFormData] = useState({
    name: client.name,
    email: client.email || '',
    phone: client.phone || '',
    whatsapp: client.whatsapp || '',
    instagram_handle: client.instagramHandle || '',
    preferred_contact: client.preferredContact || '',
    notes: client.notes || '',
    client_type: client.clientType || 'individual',
  });

  // Fetch orders for this client
  useEffect(() => {
    async function fetchOrders() {
      try {
        const response = await fetch(`/api/admin/clients/${client.id}`);
        if (response.ok) {
          const data = await response.json();
          setOrders(data.orders || []);
        }
      } catch (error) {
        console.error('Error fetching orders:', error);
      } finally {
        setIsLoadingOrders(false);
      }
    }
    fetchOrders();
  }, [client.id]);

  const handleSave = async () => {
    setIsSaving(true);
    try {
      const response = await fetch(`/api/admin/clients/${client.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });

      if (response.ok) {
        const data = await response.json();
        onUpdate(data.client);
        setIsEditing(false);
      } else {
        const error = await response.json();
        alert(error.error || 'Failed to update client');
      }
    } catch (error) {
      console.error('Error updating client:', error);
      alert('Failed to update client');
    } finally {
      setIsSaving(false);
    }
  };

  const handleDeleteClick = () => {
    setShowDeleteConfirm(true);
  };

  const handleConfirmDelete = async () => {
    setIsDeleting(true);
    try {
      const response = await fetch(`/api/admin/clients/${client.id}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        onDelete();
        onClose();
      } else {
        const error = await response.json();
        alert(error.error || t.failedToDeleteClient);
      }
    } catch (error) {
      console.error('Error deleting client:', error);
      alert(t.failedToDeleteClient);
    } finally {
      setIsDeleting(false);
      setShowDeleteConfirm(false);
    }
  };

  const getPreferredContactIcon = (preferredContact: string | null) => {
    switch (preferredContact) {
      case 'email':
        return 'üìß';
      case 'phone':
        return 'üìû';
      case 'whatsapp':
        return 'üí¨';
      case 'instagram':
        return 'üì∏';
      default:
        return 'üë§';
    }
  };

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  };

  const averageOrderValue = orders.length > 0
    ? (parseFloat(client.totalSpent || '0') / orders.length).toFixed(2)
    : '0.00';

  // Filter orders by date range for invoice
  const getFilteredOrders = () => {
    if (!invoiceFromDate && !invoiceToDate) return orders;
    
    return orders.filter(order => {
      const orderDate = new Date(order.created_at);
      const from = invoiceFromDate ? new Date(invoiceFromDate) : new Date(0);
      const to = invoiceToDate ? new Date(invoiceToDate) : new Date();
      
      // Set time to start/end of day for comparison
      from.setHours(0, 0, 0, 0);
      to.setHours(23, 59, 59, 999);
      
      return orderDate >= from && orderDate <= to;
    });
  };

  const getInvoiceFilename = () => {
    const fromDateStr = invoiceFromDate 
      ? invoiceFromDate.toLocaleDateString('it-IT').replace(/\//g, '-') 
      : 'Inizio';
    const toDateStr = invoiceToDate 
      ? invoiceToDate.toLocaleDateString('it-IT').replace(/\//g, '-') 
      : 'Oggi';
    return `Fattura_${client.name.replace(/\s+/g, '_')}_${fromDateStr}_${toDateStr}.pdf`;
  };

  const getDateRangeForPDF = () => {
    return {
      from: invoiceFromDate ? invoiceFromDate.toLocaleDateString('it-IT') : null,
      to: invoiceToDate ? invoiceToDate.toLocaleDateString('it-IT') : null,
    };
  };

  // OLD jsPDF function removed - using @react-pdf/renderer now
  // (All jsPDF code has been replaced with the InvoicePDF component and PDFDownloadLink)
      
      // Function to safely encode text for PDF (transliterate Cyrillic if needed)
      const safeText = (text: string) => {
        // Simple transliteration map for common Cyrillic characters
        const cyrillicMap: { [key: string]: string } = {
          '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'yo',
          '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm',
          '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
          '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sch',
          '—ä': '', '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya',
          '–ê': 'A', '–ë': 'B', '–í': 'V', '–ì': 'G', '–î': 'D', '–ï': 'E', '–Å': 'Yo',
          '–ñ': 'Zh', '–ó': 'Z', '–ò': 'I', '–ô': 'Y', '–ö': 'K', '–õ': 'L', '–ú': 'M',
          '–ù': 'N', '–û': 'O', '–ü': 'P', '–†': 'R', '–°': 'S', '–¢': 'T', '–£': 'U',
          '–§': 'F', '–•': 'H', '–¶': 'Ts', '–ß': 'Ch', '–®': 'Sh', '–©': 'Sch',
          '–™': '', '–´': 'Y', '–¨': '', '–≠': 'E', '–Æ': 'Yu', '–Ø': 'Ya'
        };
        
        return text.split('').map(char => cyrillicMap[char] || char).join('');
      };
      
      // Load and add logo at top
      const logoImg = new Image();
      logoImg.src = '/images/icons/logo_white_back.png';
      
      await new Promise<void>((resolve) => {
        logoImg.onload = () => {
          try {
            // Add cream background to entire page
            doc.setFillColor(253, 252, 251); // cream-50
            doc.rect(0, 0, 210, 297, 'F');
            
            // Add logo at top left
            const logoSize = 25;
            doc.addImage(logoImg, 'PNG', 15, 12, logoSize, logoSize);
            
            // Add branding next to logo with elegant serif font
            doc.setFontSize(28);
            doc.setFont('times', 'bold');
            doc.setTextColor(139, 107, 71); // brown-500
            doc.text('Bake My Cake', 45, 25);
            
            doc.setFontSize(11);
            doc.setFont('times', 'italic');
            doc.setTextColor(83, 61, 41); // brown-700
            doc.text('Pasticceria Artigianale', 45, 32);
            
            // Decorative line under header
            doc.setDrawColor(237, 215, 184); // cream-300
            doc.setLineWidth(1);
            doc.line(15, 42, 195, 42);
            
            resolve();
          } catch (error) {
            console.error('Error adding logo:', error);
            resolve();
          }
        };
        logoImg.onerror = () => {
          // Fallback: render without logo
          doc.setFillColor(253, 252, 251); // cream-50
          doc.rect(0, 0, 210, 297, 'F');
          
          doc.setFontSize(28);
          doc.setFont('times', 'bold');
          doc.setTextColor(139, 107, 71);
          doc.text('Bake My Cake', 15, 25);
          
          doc.setFontSize(11);
          doc.setFont('times', 'italic');
          doc.setTextColor(83, 61, 41);
          doc.text('Pasticceria Artigianale', 15, 32);
          
          doc.setDrawColor(237, 215, 184);
          doc.setLineWidth(1);
          doc.line(15, 42, 195, 42);
          
          resolve();
        };
      });
      
      // Invoice title in a soft rounded box
      doc.setFillColor(245, 230, 211); // cream-200
      doc.roundedRect(15, 50, 50, 12, 3, 3, 'F');
      doc.setFontSize(16);
      doc.setFont('times', 'bold');
      doc.setTextColor(83, 61, 41); // brown-700 for better contrast
      doc.text('Fattura', 40, 58.5, { align: 'center' });
      
      // Client info box (left side) - soft cream background
      doc.setFillColor(249, 246, 241); // cream-100
      doc.roundedRect(15, 68, 85, 30, 4, 4, 'F');
      
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(139, 107, 71); // brown-500
      doc.text('Cliente', 20, 75);
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(44, 44, 44); // charcoal-900
      doc.text(safeText(client.name), 20, 82);
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(74, 74, 74); // charcoal-700
      let yPos = 88;
      if (client.email) {
        doc.text(safeText(client.email), 20, yPos);
        yPos += 5;
      }
      if (client.phone) {
        doc.text(safeText(client.phone), 20, yPos);
      }
      
      // Invoice details box (right side) - soft cream background
      doc.setFillColor(249, 246, 241); // cream-100
      doc.roundedRect(110, 68, 85, 30, 4, 4, 'F');
      
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(139, 107, 71); // brown-500
      doc.text('Dettagli Fattura', 115, 75);
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(44, 44, 44);
      
      const fromDateStr = invoiceFromDate ? invoiceFromDate.toLocaleDateString('it-IT') : 'Inizio';
      const toDateStr = invoiceToDate ? invoiceToDate.toLocaleDateString('it-IT') : 'Oggi';
      doc.text(`Periodo: ${fromDateStr} - ${toDateStr}`, 115, 82);
      
      const invoiceNum = `${new Date().getFullYear()}-${client.id.slice(0, 8)}`;
      doc.text(`N. Fattura: ${invoiceNum}`, 115, 88);
      doc.text(`Data: ${new Date().toLocaleDateString('it-IT')}`, 115, 94);
      
      // Build table data with order items
      const tableData: any[] = [];
      
      filteredOrders.forEach(order => {
        // Add order header row
        const orderNum = order.order_number || order.id.slice(0, 8);
        const deliveryDate = order.delivery_date ? new Date(order.delivery_date).toLocaleDateString('it-IT') : '-';
        
        tableData.push([
          {
            content: `Ordine: ${orderNum} | Consegna: ${deliveryDate}`,
            colSpan: 4,
            styles: { 
              fillColor: [245, 230, 211], // cream-200
              textColor: [83, 61, 41], // brown-700 for better contrast
              fontStyle: 'bold',
              fontSize: 10,
              cellPadding: 4
            }
          }
        ]);
        
        // Add order items
        if (order.order_items && order.order_items.length > 0) {
          order.order_items.forEach(item => {
            tableData.push([
              safeText(item.product_name),
              item.quantity.toString(),
              `CHF ${parseFloat(item.unit_price).toFixed(2)}`,
              `CHF ${parseFloat(item.subtotal).toFixed(2)}`
            ]);
          });
        } else {
          // Fallback if no items (shouldn't happen)
          tableData.push([
            'Ordine completo',
            '1',
            `CHF ${parseFloat(order.total_amount).toFixed(2)}`,
            `CHF ${parseFloat(order.total_amount).toFixed(2)}`
          ]);
        }
      });
      
      // Calculate table dimensions for perfect centering
      const tableWidth = 80 + 20 + 35 + 35; // 170mm total
      const pageWidth = 210; // A4 width in mm
      const tableMarginX = (pageWidth - tableWidth) / 2; // Center horizontally
      
      autoTable(doc, {
        startY: 108,
        margin: { left: tableMarginX, right: tableMarginX },
        head: [['Prodotto', 'Qta', 'Prezzo Unit.', 'Subtotale']],
        body: tableData,
        theme: 'grid',
        headStyles: {
          fillColor: [139, 107, 71], // brown-500
          textColor: [253, 252, 251], // cream-50
          fontStyle: 'bold',
          fontSize: 11,
          cellPadding: 5
        },
        styles: {
          fontSize: 10,
          cellPadding: 5,
          lineColor: [237, 215, 184], // cream-300
          lineWidth: 0.5
        },
        alternateRowStyles: {
          fillColor: [253, 252, 251] // cream-50
        },
        bodyStyles: {
          textColor: [44, 44, 44] // charcoal-900
        },
        columnStyles: {
          0: { cellWidth: 80 },
          1: { cellWidth: 20, halign: 'center' },
          2: { cellWidth: 35, halign: 'right' },
          3: { cellWidth: 35, halign: 'right', fontStyle: 'bold' }
        }
      });
      
      // Calculate totals
      const totalAmount = filteredOrders.reduce((sum, order) => sum + parseFloat(order.total_amount), 0);
      
      const finalY = (doc as any).lastAutoTable?.finalY || 150;
      
      // Draw totals box - perfectly aligned with table
      const boxStartY = finalY + 12;
      const boxWidth = 80; // Wider for better proportion
      const boxHeight = 18;
      // Align box to right edge of table
      const boxX = tableMarginX + tableWidth - boxWidth;
      
      // Gradient-like effect with nested rounded rectangles
      doc.setFillColor(139, 107, 71); // brown-500
      doc.roundedRect(boxX, boxStartY, boxWidth, boxHeight, 4, 4, 'F');
      
      // Inner lighter box for depth
      doc.setFillColor(166, 138, 107); // brown-400
      doc.roundedRect(boxX + 1, boxStartY + 1, boxWidth - 2, boxHeight - 2, 3, 3, 'F');
      
      // Totale label
      doc.setFont('times', 'bold');
      doc.setFontSize(13);
      doc.setTextColor(253, 252, 251); // cream-50
      doc.text('Totale:', boxX + 6, boxStartY + 12);
      
      // Totale amount
      doc.setFontSize(14);
      doc.text(`CHF ${totalAmount.toFixed(2)}`, boxX + boxWidth - 6, boxStartY + 12, { align: 'right' });
      
      // Footer with logo
      const footerY = 270;
      
      // Decorative line above footer
      doc.setDrawColor(237, 215, 184); // cream-300
      doc.setLineWidth(0.5);
      doc.line(15, footerY - 5, 195, footerY - 5);
      
      // Thank you message
      doc.setFontSize(11);
      doc.setFont('times', 'italic');
      doc.setTextColor(139, 107, 71); // brown-500
      doc.text('Grazie per la vostra fiducia!', 105, footerY + 3, { align: 'center' });
      
      // Add small logo at bottom center
      const logoWidth = 20;
      const logoHeight = 20;
      const logoX = (210 - logoWidth) / 2; // Center on A4 page (210mm width)
      
      try {
        doc.addImage(logoImg, 'PNG', logoX, footerY + 8, logoWidth, logoHeight);
      } catch (error) {
        console.error('Could not add footer logo:', error);
      }
      
      // Footer text below logo
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(107, 107, 107); // charcoal-500
      doc.text('Bake My Cake - Pasticceria Artigianale', 105, footerY + 32, { align: 'center' });
      
      // Save PDF

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div className="bg-cream-50 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="bg-gradient-to-r from-brown-500 to-brown-600 px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <h2 className="text-2xl font-heading font-bold text-white">
              {client.name}
            </h2>
            {client.clientType === 'business' && (
              <span className="px-3 py-1 bg-amber-400 text-charcoal-900 text-xs font-bold rounded-full flex items-center gap-1">
                <Briefcase className="w-3 h-3" />
                –ë–∏–∑–Ω–µ—Å
              </span>
            )}
          </div>
          <button
            onClick={onClose}
            className="text-white hover:text-cream-200 transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          {/* Client Details */}
          <div className="bg-white border-2 border-cream-200 rounded-xl p-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-heading font-bold text-charcoal-900">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
              {!isEditing && (
                <button
                  onClick={() => setIsEditing(true)}
                  className="px-4 py-2 bg-brown-500 text-white rounded-lg hover:bg-brown-600 transition-colors text-sm font-semibold"
                >
                  {t.edit}
                </button>
              )}
            </div>

            {isEditing ? (
              <div className="space-y-4">
                {/* Client Type */}
                <div>
                  <label className="block text-sm font-semibold text-charcoal-700 mb-2">–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞</label>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      type="button"
                      onClick={() => setFormData({ ...formData, client_type: 'individual' })}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all border-2 ${
                        formData.client_type === 'individual'
                          ? 'bg-brown-500 text-white border-brown-500'
                          : 'bg-white text-charcoal-700 border-cream-300 hover:border-brown-300'
                      }`}
                    >
                      –§–∏–∑. –ª–∏—Ü–æ
                    </button>
                    <button
                      type="button"
                      onClick={() => setFormData({ ...formData, client_type: 'business' })}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all border-2 ${
                        formData.client_type === 'business'
                          ? 'bg-brown-500 text-white border-brown-500'
                          : 'bg-white text-charcoal-700 border-cream-300 hover:border-brown-300'
                      }`}
                    >
                      –ë–∏–∑–Ω–µ—Å
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-semibold text-charcoal-700 mb-2">
                    {t.name}
                  </label>
                  <input
                    type="text"
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    className="w-full px-4 py-2 rounded-lg border-2 border-cream-300 focus:border-brown-500 focus:outline-none"
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-charcoal-700 mb-2">{t.email}</label>
                    <input
                      type="email"
                      value={formData.email}
                      onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                      className="w-full px-4 py-2 rounded-lg border-2 border-cream-300 focus:border-brown-500 focus:outline-none"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-charcoal-700 mb-2">{t.phone}</label>
                    <input
                      type="tel"
                      value={formData.phone}
                      onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                      className="w-full px-4 py-2 rounded-lg border-2 border-cream-300 focus:border-brown-500 focus:outline-none"
                    />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-charcoal-700 mb-2">WhatsApp</label>
                    <input
                      type="tel"
                      value={formData.whatsapp}
                      onChange={(e) => setFormData({ ...formData, whatsapp: e.target.value })}
                      className="w-full px-4 py-2 rounded-lg border-2 border-cream-300 focus:border-brown-500 focus:outline-none"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-charcoal-700 mb-2">Instagram</label>
                    <input
                      type="text"
                      value={formData.instagram_handle}
                      onChange={(e) => setFormData({ ...formData, instagram_handle: e.target.value })}
                      placeholder="@username"
                      className="w-full px-4 py-2 rounded-lg border-2 border-cream-300 focus:border-brown-500 focus:outline-none"
                    />
                  </div>
                </div>
                <div>
                    <label className="block text-sm font-semibold text-charcoal-700 mb-2">{t.preferredContact}</label>
                  <select
                    value={formData.preferred_contact}
                    onChange={(e) => setFormData({ ...formData, preferred_contact: e.target.value })}
                    className="w-full px-4 py-2 rounded-lg border-2 border-cream-300 focus:border-brown-500 focus:outline-none"
                  >
                    <option value="">–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</option>
                    <option value="email">üìß Email</option>
                    <option value="phone">üìû –¢–µ–ª–µ—Ñ–æ–Ω</option>
                    <option value="whatsapp">üí¨ WhatsApp</option>
                    <option value="instagram">üì∏ Instagram</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-charcoal-700 mb-2">{t.notes}</label>
                  <textarea
                    value={formData.notes}
                    onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                    rows={3}
                    placeholder="–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ..."
                    className="w-full px-4 py-2 rounded-lg border-2 border-cream-300 focus:border-brown-500 focus:outline-none"
                  />
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={handleSave}
                    disabled={isSaving}
                    className="flex-1 px-4 py-2 bg-brown-500 text-white rounded-lg hover:bg-brown-600 transition-colors disabled:opacity-50"
                  >
                    {isSaving ? t.saving : t.save}
                  </button>
                  <button
                    onClick={() => {
                      setIsEditing(false);
                      setFormData({
                        name: client.name,
                        email: client.email || '',
                        phone: client.phone || '',
                        whatsapp: client.whatsapp || '',
                        instagram_handle: client.instagramHandle || '',
                        preferred_contact: client.preferredContact || '',
                        notes: client.notes || '',
                        client_type: client.clientType || 'individual',
                      });
                    }}
                    className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                  >
                    {t.cancel}
                  </button>
                </div>
              </div>
            ) : (
              <div className="space-y-3 text-charcoal-700">
                {client.email && <p className="flex items-center gap-2">üìß {client.email}</p>}
                {client.phone && <p className="flex items-center gap-2">üìû {client.phone}</p>}
                {client.whatsapp && <p className="flex items-center gap-2">üí¨ {client.whatsapp}</p>}
                {client.instagramHandle && <p className="flex items-center gap-2">üì∏ @{client.instagramHandle}</p>}
                {client.preferredContact && (
                  <p className="text-sm text-charcoal-500">
                    –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π: {getPreferredContactIcon(client.preferredContact)} {client.preferredContact}
                  </p>
                )}
                {client.notes && (
                  <div className="mt-4 pt-4 border-t border-cream-200">
                    <p className="text-sm font-semibold text-charcoal-700 mb-1">{t.notes}:</p>
                    <p className="text-sm text-charcoal-600">{client.notes}</p>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Order History */}
          <div className="bg-white border-2 border-cream-200 rounded-xl p-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-heading font-bold text-charcoal-900">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
              
              {/* Invoice Generator Button (only for business clients) */}
              {client.clientType === 'business' && orders.length > 0 && (
                <button
                  onClick={() => setShowInvoiceGenerator(!showInvoiceGenerator)}
                  className="flex items-center gap-2 px-4 py-2 bg-brown-500 text-white rounded-lg hover:bg-brown-600 transition-colors text-sm font-semibold"
                >
                  <FileDown className="w-4 h-4" />
                  Genera Fattura
                </button>
              )}
            </div>

            {/* Invoice Date Range Selector */}
            {showInvoiceGenerator && (
              <div className="mb-6 p-4 bg-amber-50 border-2 border-amber-200 rounded-xl">
                <h4 className="text-sm font-semibold text-charcoal-900 mb-3">Seleziona periodo per la fattura</h4>
                <div className="grid grid-cols-2 gap-4 mb-4">
                  <DatePicker
                    selectedDate={invoiceFromDate}
                    onDateChange={setInvoiceFromDate}
                    locale="it"
                    minDate={new Date(2020, 0, 1)}
                    label="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞"
                    placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞"
                    showHelperText={false}
                  />
                  <DatePicker
                    selectedDate={invoiceToDate}
                    onDateChange={setInvoiceToDate}
                    locale="it"
                    minDate={invoiceFromDate || new Date(2020, 0, 1)}
                    label="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"
                    placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è"
                    showHelperText={false}
                  />
                </div>
                <div className="flex gap-3">
                  {!invoiceFromDate || !invoiceToDate ? (
                    <button
                      disabled
                      className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-brown-500 text-white rounded-lg opacity-50 cursor-not-allowed"
                    >
                      <Download className="w-4 h-4" />
                      Scarica PDF
                    </button>
                  ) : (
                    <PDFDownloadLink
                      document={
                        <InvoicePDF
                          client={client}
                          orders={getFilteredOrders()}
                          dateRange={getDateRangeForPDF()}
                        />
                      }
                      fileName={getInvoiceFilename()}
                      className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-brown-500 text-white rounded-lg hover:bg-brown-600 transition-colors"
                    >
                      {({ loading }) =>
                        loading ? (
                          <>
                            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            Generazione...
                          </>
                        ) : (
                          <>
                            <Download className="w-4 h-4" />
                            Scarica PDF
                          </>
                        )
                      }
                    </PDFDownloadLink>
                  )}
                  <button
                    onClick={() => setShowInvoiceGenerator(false)}
                    className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                  >
                    Annulla
                  </button>
                </div>
              </div>
            )}

            {isLoadingOrders ? (
              <p className="text-charcoal-500 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
            ) : orders.length === 0 ? (
              <p className="text-charcoal-500 text-center py-8">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
            ) : (
              <div className="space-y-3">
                {orders.map((order) => (
                  <div
                    key={order.id}
                    className="flex items-center justify-between p-4 bg-cream-50 rounded-lg border border-cream-200 hover:border-brown-300 transition-colors"
                  >
                    <div>
                      <p className="font-semibold text-charcoal-900">
                        {order.order_number || `#${order.id.slice(0, 8)}`}
                      </p>
                      <p className="text-sm text-charcoal-600">
                        {order.delivery_date
                          ? new Date(order.delivery_date).toLocaleDateString('ru-RU')
                          : new Date(order.created_at).toLocaleDateString('ru-RU')}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="font-bold text-brown-600">CHF {parseFloat(order.total_amount).toFixed(2)}</p>
                      <p className={`text-sm ${order.paid ? 'text-green-600' : 'text-orange-600'}`}>
                        {order.paid ? '–û–ø–ª–∞—á–µ–Ω–æ' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ'}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Statistics */}
          <div className="grid grid-cols-3 gap-4">
            <div className="bg-white border-2 border-cream-200 rounded-xl p-4 text-center">
              <p className="text-sm text-charcoal-600 mb-1">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</p>
              <p className="text-2xl font-bold text-brown-600">{client.totalOrders}</p>
            </div>
            <div className="bg-white border-2 border-cream-200 rounded-xl p-4 text-center">
              <p className="text-sm text-charcoal-600 mb-1">{t.totalSpent}</p>
              <p className="text-2xl font-bold text-brown-600">CHF {parseFloat(client.totalSpent || '0').toFixed(2)}</p>
            </div>
            <div className="bg-white border-2 border-cream-200 rounded-xl p-4 text-center">
              <p className="text-sm text-charcoal-600 mb-1">–ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑</p>
              <p className="text-lg font-semibold text-charcoal-900">
                {client.firstOrderDate ? new Date(client.firstOrderDate).toLocaleDateString('ru-RU') : '-'}
              </p>
            </div>
          </div>
        </div>

        {/* Footer - Delete Button */}
        <div className="bg-cream-100 px-6 py-4 border-t-2 border-cream-200">
          <button
            onClick={() => setShowDeleteConfirm(true)}
            disabled={isDeleting}
            className="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50"
          >
            {isDeleting ? t.deleting : '–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞'}
          </button>
        </div>
      </div>

      {/* Delete Confirmation Dialog */}
      <ConfirmationDialog
        isOpen={showDeleteConfirm}
        title={t.confirmDelete}
        message="–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ö–ª–∏–µ–Ω—Ç –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞."
        confirmText={t.delete}
        cancelText={t.cancel}
        onClose={() => setShowDeleteConfirm(false)}
        onConfirm={async () => {
          setIsDeleting(true);
          await onDelete();
          setIsDeleting(false);
          setShowDeleteConfirm(false);
          onClose();
        }}
      />
    </div>
  );
}
